name: Deploy Windchasers Web-Agent

on:
  push:
    branches:
      - production
      - main
    paths:
      - 'brand/windchasers/web-agent/build/**'
      - '.github/workflows/deploy-windchasers-web-agent.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.WINDCHASERS_VPS_SSH_KEY }}
      
      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.WINDCHASERS_VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to VPS via Rsync
        run: |
          rsync -avz --delete \
            --exclude='.env.local' \
            --exclude='node_modules' \
            --exclude='.next' \
            --exclude='.git' \
            --exclude='*.log' \
            --exclude='.DS_Store' \
            -e "ssh -o StrictHostKeyChecking=no" \
            brand/windchasers/web-agent/build/ \
            ${{ secrets.WINDCHASERS_VPS_USER }}@${{ secrets.WINDCHASERS_VPS_HOST }}:/var/www/windchasers-web-agent/
      
      - name: Deploy PM2 Ecosystem Config
        run: |
          if [ -f brand/windchasers/web-agent/build/ecosystem.config.js ]; then
            rsync -avz \
              -e "ssh -o StrictHostKeyChecking=no" \
              brand/windchasers/web-agent/build/ecosystem.config.js \
              ${{ secrets.WINDCHASERS_VPS_USER }}@${{ secrets.WINDCHASERS_VPS_HOST }}:/var/www/windchasers-web-agent/ecosystem.config.js
          else
            echo "‚ö†Ô∏è  Ecosystem config not found, will use individual PM2 process"
          fi
      
      - name: Build and Restart on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.WINDCHASERS_VPS_HOST }}
          username: ${{ secrets.WINDCHASERS_VPS_USER }}
          key: ${{ secrets.WINDCHASERS_VPS_SSH_KEY }}
          port: 22
          timeout: 900s
          command_timeout: 15m
          script: |
            cd /var/www/windchasers-web-agent
            
            # Create logs directory if it doesn't exist
            mkdir -p logs
            
            # Verify .env.local exists and contains required Supabase variables
            if [ ! -f .env.local ]; then
              echo "‚ùå ERROR: .env.local not found on VPS!"
              echo "Please create .env.local with required Supabase credentials:"
              echo "  - NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL"
              echo "  - NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY"
              echo "  - WINDCHASERS_SUPABASE_SERVICE_KEY (or SUPABASE_SERVICE_ROLE_KEY)"
              echo "  - CLAUDE_API_KEY"
              exit 1
            fi
            
            # Check for required Supabase environment variables
            echo "üîç Verifying Supabase environment variables..."
            if ! grep -q "NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL" .env.local || ! grep -q "NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY" .env.local; then
              echo "‚ùå ERROR: Required Supabase environment variables not found in .env.local"
              echo "Missing variables:"
              grep -q "NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL" .env.local || echo "  - NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL"
              grep -q "NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY" .env.local || echo "  - NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY"
              exit 1
            fi
            echo "‚úÖ Supabase environment variables found in .env.local"
            
            # Install dependencies (need dev deps for build)
            echo "üì¶ Installing dependencies..."
            npm ci

            # Build the application
            echo "üèóÔ∏è  Building Next.js application..."
            echo "‚è±Ô∏è  This may take 5-10 minutes (including type checking)..."
            # Set NODE_OPTIONS to increase memory if needed
            export NODE_OPTIONS="--max-old-space-size=4096"
            npm run build
            
            # Check build exit code
            BUILD_EXIT_CODE=$?
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "‚ùå ERROR: Build failed with exit code: $BUILD_EXIT_CODE"
              echo "Checking for build errors..."
              exit 1
            fi
            
            # Verify build succeeded
            if [ ! -d ".next" ]; then
              echo "‚ùå ERROR: Build failed - .next directory not found!"
              echo "Current directory contents:"
              ls -la
              exit 1
            fi
            
            echo "‚úÖ Build successful - .next directory exists"
            
            # Deploy ecosystem config if it exists
            if [ -f ecosystem.config.js ]; then
              echo "‚úÖ Ecosystem config found, will use for PM2"
            else
              echo "‚ö†Ô∏è  Ecosystem config not found, will use individual PM2 process"
            fi
            
            # Force stop and delete old process to ensure clean restart
            echo "üîÑ Stopping old process..."
            pm2 stop windchasers-web-agent 2>/dev/null || true
            pm2 delete windchasers-web-agent 2>/dev/null || true
            pm2 stop ecosystem.config.js --only windchasers-web-agent 2>/dev/null || true
            sleep 2
            
            # Restart using PM2 ecosystem (if exists in web-agent directory) or individual process
            echo "üîÑ Starting web-agent with PM2..."
            if [ -f ecosystem.config.js ]; then
              # Use ecosystem file from web-agent directory
              pm2 start ecosystem.config.js --only windchasers-web-agent || {
                echo "‚ùå Failed to start with ecosystem, trying fallback..."
                PORT=3001 pm2 start npm --name windchasers-web-agent -- start
              }
            else
              # Fallback to individual process
              PORT=3001 pm2 start npm --name windchasers-web-agent -- start
            fi
            
            # Save PM2 configuration
            pm2 save
            
            # Save PM2 configuration
            pm2 save
            
            # Verify process is running
            echo "üìä Verifying PM2 process..."
            pm2 list | grep windchasers-web-agent || echo "‚ö†Ô∏è  Process not found in PM2 list"
            pm2 describe windchasers-web-agent | head -20 || true
            
            # Wait for app to start
            echo "‚è≥ Waiting for app to start..."
            sleep 10
            
            # Health check with retries
            MAX_RETRIES=5
            RETRY_COUNT=0
            HEALTH_CHECK_PASSED=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f http://localhost:3001/widget > /dev/null 2>&1; then
                echo "‚úÖ Health check passed (widget endpoint)"
                HEALTH_CHECK_PASSED=true
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
                  sleep 3
                fi
              fi
            done
            
            if [ "$HEALTH_CHECK_PASSED" = false ]; then
              echo "‚ö†Ô∏è  Health check failed after $MAX_RETRIES attempts"
              echo "Checking PM2 logs..."
              pm2 logs windchasers-web-agent --lines 20 --nostream || true
            fi
            
            # Verify Supabase client initialization (check logs for errors)
            echo ""
            echo "üîç Verifying Supabase connection..."
            sleep 3
            SUPABASE_ERRORS=$(pm2 logs windchasers-web-agent --lines 50 --nostream 2>&1 | grep -i "supabase\|supabase" | grep -i "error\|fail" || echo "")
            
            if [ -n "$SUPABASE_ERRORS" ]; then
              echo "‚ö†Ô∏è  WARNING: Potential Supabase errors found in logs:"
              echo "$SUPABASE_ERRORS" | head -5
            else
              echo "‚úÖ No Supabase errors found in logs"
            fi
            
            # Check if Supabase environment variables are being used
            echo "üìã Supabase environment check:"
            if grep -q "NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL" .env.local; then
              SUPABASE_URL=$(grep "NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL" .env.local | cut -d '=' -f2 | tr -d '"' | tr -d "'")
              if [ -n "$SUPABASE_URL" ] && [ "$SUPABASE_URL" != "placeholder" ]; then
                echo "  ‚úÖ NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL is set"
              else
                echo "  ‚ö†Ô∏è  NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL appears to be placeholder"
              fi
            else
              echo "  ‚ùå NEXT_PUBLIC_WINDCHASERS_SUPABASE_URL not found"
            fi
            
            if grep -q "NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY" .env.local; then
              ANON_KEY=$(grep "NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY" .env.local | cut -d '=' -f2 | tr -d '"' | tr -d "'")
              if [ -n "$ANON_KEY" ] && [ "$ANON_KEY" != "placeholder" ] && [ ${#ANON_KEY} -gt 50 ]; then
                echo "  ‚úÖ NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY is set and appears valid"
              else
                echo "  ‚ö†Ô∏è  NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY appears invalid or placeholder"
              fi
            else
              echo "  ‚ùå NEXT_PUBLIC_WINDCHASERS_SUPABASE_ANON_KEY not found"
            fi
            
            # Show PM2 status
            echo ""
            echo "‚úÖ Deployment complete. PM2 status:"
            pm2 list | grep windchasers-web-agent || echo "‚ö†Ô∏è  Process not found in PM2 list"
